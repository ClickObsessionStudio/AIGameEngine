<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Keep of the Last Knight</title>
<style>
  :root {
    --bg:#0e0e12; --panel:#181822; --ink:#f1f3f5; --muted:#b8c1cc; --accent:#35c759; --danger:#ff3b30; --warn:#f7b500; --btn:#2c2f3a; --btn2:#263248; --grid:#232335; --z:#3fe081; --z2:#1b6b3a;
  }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased;}
  header{padding:12px 16px;background:var(--panel);position:sticky;top:0;z-index:3;box-shadow:0 2px 0 rgba(0,0,0,.25)}
  h1{margin:0;font-size:1.25rem}
  .sub{font-size:.85rem;color:var(--muted)}
  .wrap{max-width:720px;margin:0 auto;padding:12px 12px 64px}
  .stats{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .badge{background:var(--grid);padding:6px 10px;border-radius:8px;}
  .stam{display:inline-flex;gap:2px;margin-left:4px}
  .pip{width:14px;height:14px;border-radius:3px;background:#333;outline:1px solid #000}
  .pip.full{background:linear-gradient(180deg,#77d,#44a)}
  .pip.low{background:linear-gradient(180deg,#d77,#a44)}
  .game{display:grid;gap:12px}
  .board{background:var(--panel);padding:10px;border-radius:12px}
  .legend{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;color:var(--muted);font-size:.9rem}
  .grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px}
  .cell{position:relative;background:var(--grid);border-radius:8px;aspect-ratio:1/1;outline:1px solid rgba(255,255,255,.06)}
  .cell[data-col="0"]{box-shadow:inset 4px 0 0 0 rgba(255,59,48,.25)}
  .keepLabel{font-size:.8rem;color:var(--muted)}
  .cell.z{background:radial-gradient(circle at 35% 35%, var(--z), var(--z2) 60%, #0c331c 100%);}
  .cell.z::after{content:"";position:absolute;inset:2px;border-radius:7px;box-shadow:inset 0 0 0 2px rgba(0,0,0,.25)}
  .cell.slash{animation:slash .18s ease-out}
  @keyframes slash{from{box-shadow:0 0 0 0 rgba(255,255,255,.0), inset 0 0 16px rgba(255,255,255,.0)}to{box-shadow:0 0 0 4px rgba(255,255,255,.25), inset 0 0 16px rgba(255,255,255,.2)}}
  .controls{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .rowBtns{grid-column:1 / -1;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  button{appearance:none;border:none;border-radius:12px;background:var(--btn);color:var(--ink);padding:14px 12px;font-size:1.05rem;min-height:48px;cursor:pointer;box-shadow:0 2px 0 rgba(0,0,0,.4)}
  .rest{background:var(--btn2)}
  .pause{background:#3a3d4a}
  .new{background:#2b3a2f}
  .dangerTxt{color:var(--danger)}
  .okTxt{color:var(--accent)}
  button:active{transform:translateY(1px)}
  button:focus-visible{outline:3px solid var(--accent);outline-offset:2px}
  .footer{margin-top:10px;color:var(--muted);font-size:.9rem}
  details{background:var(--panel);padding:10px;border-radius:12px}
  summary{cursor:pointer}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:16px;z-index:5}
  .overlay[aria-hidden="false"]{display:flex}
  .dialog{background:var(--panel);color:var(--ink);padding:16px;border-radius:14px;max-width:420px;width:100%;box-shadow:0 8px 24px rgba(0,0,0,.5)}
  .dialog h2{margin:.25rem 0 0}
  .dialog p{margin:.5rem 0}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  @media (prefers-reduced-motion: reduce){
    *{animation-duration:.001ms !important;animation-iteration-count:1 !important;transition-duration:.001ms !important;scroll-behavior:auto !important}
  }
</style>
</head>
<body>
<header>
  <h1>Keep of the Last Knight</h1>
  <div class="stats" role="status" aria-live="polite">
    <div class="badge" id="score">Kills: 0</div>
    <div class="badge" id="time">Time: 0s</div>
    <div class="badge" id="best">Best: 0</div>
    <div class="badge">Stamina: <span id="stamText">3/3</span><span class="stam" aria-hidden="true" id="stamPips"></span></div>
  </div>
</header>
<main class="wrap">
  <div class="game">
    <div class="board" aria-label="Defend the keep from zombies">
      <div class="legend"><span class="keepLabel">Left edge: your KEEP</span><span id="speed" class="sub">Speed: 1x</span></div>
      <div class="grid" id="grid" role="presentation" aria-hidden="true"></div>
    </div>
    <div class="controls" aria-label="Controls">
      <div class="rowBtns">
        <button id="r0" class="strike" aria-label="Strike high lane" title="Strike high lane (1)">‚öîÔ∏è High</button>
        <button id="r1" class="strike" aria-label="Strike middle lane" title="Strike middle lane (2)">‚öîÔ∏è Mid</button>
        <button id="r2" class="strike" aria-label="Strike low lane" title="Strike low lane (3)">‚öîÔ∏è Low</button>
      </div>
      <button id="rest" class="rest" aria-label="Catch breath to recover stamina" title="Recover stamina (R)">üõ°Ô∏è Rest</button>
      <button id="pause" class="pause" aria-label="Pause or resume" title="Pause / Resume (Space)">‚è∏Ô∏è Pause</button>
      <button id="new" class="new" aria-label="Start a new run" title="New Run (N)">üîÑ New Run</button>
    </div>
    <div class="footer">
      <details>
        <summary>Help &amp; About</summary>
        <p>Hold the keep by striking zombies in the lane they approach. A strike reaches the first two tiles in that lane. If a zombie advances past the keep, you are bitten and the run ends.</p>
        <ul>
          <li>Tap a lane button or press keys 1/2/3 to strike High/Mid/Low.</li>
          <li>Rest (tap or R) to recover stamina. You also regain a little stamina over time.</li>
          <li>Space = Pause/Resume, N = New Run.</li>
        </ul>
        <p>Best kill count is saved on this device.</p>
        <div class="row">
          <button id="resetData" aria-label="Reset saved best score">Reset Saved Best</button>
        </div>
        <p class="sub">Accessible: large tap targets, high contrast, keyboard support, reduced motion respected.</p>
      </details>
    </div>
  </div>
</main>
<div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="false">
  <div class="dialog">
    <h2 id="ovTitle">Medieval Zombie Survival</h2>
    <p id="ovMsg">Tap Play to begin. Strike the undead before they breach your wall.</p>
    <div class="row">
      <button id="ovPlay" class="ok">‚ñ∂Ô∏è Play</button>
    </div>
  </div>
</div>
<div id="announcer" class="sr" aria-live="polite"></div>
<script>
(function(){
  'use strict';
  const ROWS=3, COLS=8, REACH=2;
  let grid = []; // 0/1
  let running=false, timer=null;
  let tickMs=800, tickCount=0, minTick=250, spawnProb=0.35;
  let kills=0, timeS=0, timeTimer=null;
  let stamina=3, maxStamina=3, regenCounter=0;
  let best=0;

  const elGrid = document.getElementById('grid');
  const elScore = document.getElementById('score');
  const elTime = document.getElementById('time');
  const elBest = document.getElementById('best');
  const elStamText = document.getElementById('stamText');
  const elStamPips = document.getElementById('stamPips');
  const elSpeed = document.getElementById('speed');
  const announcer = document.getElementById('announcer');
  const overlay = document.getElementById('overlay');
  const ovPlay = document.getElementById('ovPlay');
  const ovTitle = document.getElementById('ovTitle');
  const ovMsg = document.getElementById('ovMsg');

  // Build grid cells
  const cells=[]; // [row][col] => element
  function buildGrid(){
    elGrid.innerHTML='';
    for(let r=0;r<ROWS;r++){
      cells[r]=[];
      for(let c=0;c<COLS;c++){
        const d=document.createElement('div');
        d.className='cell';
        d.dataset.row=String(r);
        d.dataset.col=String(c);
        elGrid.appendChild(d);
        cells[r][c]=d;
      }
    }
  }

  function zeroGrid(){
    grid=new Array(ROWS);
    for(let r=0;r<ROWS;r++){grid[r]=new Array(COLS).fill(0);}    
  }

  function renderGrid(){
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const el=cells[r][c];
        if(grid[r][c]){el.classList.add('z');}
        else {el.classList.remove('z');}
      }
    }
  }

  function updateStats(){
    elScore.textContent='Kills: '+kills;
    elTime.textContent='Time: '+timeS+'s';
    elBest.textContent='Best: '+best;
    elStamText.textContent=stamina+'/'+maxStamina;
    elStamPips.innerHTML='';
    for(let i=0;i<maxStamina;i++){
      const p=document.createElement('span');
      p.className='pip'+(i<stamina?' full':'');
      if(stamina===0 && i===0) p.className='pip low';
      elStamPips.appendChild(p);
    }
    const speedMul=(800/tickMs).toFixed(1).replace('.0','');
    elSpeed.textContent='Speed: '+speedMul+'x';
  }

  function announce(msg){announcer.textContent=msg;}

  function nearestIdx(row){
    for(let c=0;c<COLS;c++){ if(grid[row][c]) return c; }
    return -1;
  }

  function flashCell(r,c){
    if(c<0 || c>=COLS) return;
    const el=cells[r][c];
    el.classList.remove('slash'); // restart anima
    void el.offsetWidth;
    el.classList.add('slash');
    setTimeout(function(){ el.classList.remove('slash'); }, 220);
  }

  function strike(row){
    if(!running) return;
    if(stamina<=0){ announce('Too tired!'); return; }
    const idx=nearestIdx(row);
    if(idx>-1 && idx<=REACH){
      grid[row][idx]=0;
      kills++;
      stamina=Math.max(0, stamina-1);
      flashCell(row, idx);
      renderGrid();
      updateStats();
      announce('Hit lane '+(row===0?'high':row===1?'middle':'low'));
    } else {
      announce('No target in range');
    }
  }

  function rest(){
    if(!running) return;
    if(stamina<maxStamina){ stamina++; updateStats(); announce('Catching breath'); }
    else announce('Stamina full');
  }

  function moveZombies(){
    let bitten=false;
    const newG=new Array(ROWS);
    for(let r=0;r<ROWS;r++){
      newG[r]=new Array(COLS).fill(0);
      for(let c=0;c<COLS;c++){
        if(grid[r][c]){
          if(c===0){
            bitten=true; // would step beyond keep
          } else {
            newG[r][c-1]=1;
          }
        }
      }
    }
    grid=newG;
    return bitten;
  }

  function spawnZombie(){
    if(Math.random()<spawnProb){
      const choices=[];
      for(let r=0;r<ROWS;r++){ if(!grid[r][COLS-1]) choices.push(r); }
      if(choices.length){
        const r=choices[Math.floor(Math.random()*choices.length)];
        grid[r][COLS-1]=1;
      }
    }
  }

  function tick(){
    if(!running) return;
    // stamina regen
    regenCounter++;
    if(regenCounter>=2){ regenCounter=0; if(stamina<maxStamina){ stamina++; }}
    const bitten=moveZombies();
    if(bitten){
      renderGrid();
      gameOver();
      return;
    }
    spawnZombie();
    tickCount++;
    if(tickCount%20===0 && tickMs>minTick){
      tickMs-=50; if(tickMs<minTick) tickMs=minTick;
      spawnProb=Math.min(0.9, spawnProb+0.05);
      restartInterval();
    }
    renderGrid();
    updateStats();
  }

  function startTime(){
    if(timeTimer) clearInterval(timeTimer);
    timeTimer=setInterval(function(){ if(running){ timeS++; updateStats(); } },1000);
  }

  function stopTime(){ if(timeTimer){ clearInterval(timeTimer); timeTimer=null; } }

  function startInterval(){ if(timer) clearInterval(timer); timer=setInterval(tick, tickMs); }
  function restartInterval(){ if(timer) { clearInterval(timer); timer=setInterval(tick, tickMs); } }

  function loadBest(){
    try{ const v=localStorage.getItem('mzs_best_kills_v1'); if(v!==null){ const n=parseInt(v,10); if(!isNaN(n)) best=n; }}catch(e){}
  }
  function saveBest(){ try{ localStorage.setItem('mzs_best_kills_v1', String(best)); }catch(e){} }
  function resetData(){ try{ localStorage.removeItem('mzs_best_kills_v1'); best=0; updateStats(); announce('Saved best reset'); }catch(e){} }

  function newRun(){
    pauseGame(false);
    zeroGrid();
    kills=0; timeS=0; tickCount=0; regenCounter=0; stamina=maxStamina; tickMs=800; spawnProb=0.35;
    renderGrid(); updateStats();
    hideOverlay();
    running=true;
    startInterval(); startTime();
    updatePauseBtn();
    announce('Run started');
  }

  function gameOver(){
    running=false; if(timer){ clearInterval(timer); timer=null; }
    stopTime();
    if(kills>best){ best=kills; saveBest(); }
    updateStats();
    ovTitle.textContent='You were bitten!';
    ovMsg.textContent='Final Kills: '+kills+' ‚Ä¢ Time: '+timeS+'s';
    ovPlay.textContent='Try Again';
    showOverlay();
    announce('Game over');
  }

  function pauseGame(toggleMsg){
    if(timer){ clearInterval(timer); timer=null; }
    running=false; updatePauseBtn(); if(toggleMsg!==false) announce('Paused');
  }
  function resumeGame(){ running=true; startInterval(); updatePauseBtn(); announce('Resumed'); }
  function togglePause(){ if(running){ pauseGame(); } else { resumeGame(); } }
  function updatePauseBtn(){
    const btn=document.getElementById('pause');
    btn.textContent = running ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Resume';
  }

  function showOverlay(){ overlay.setAttribute('aria-hidden','false'); setTimeout(function(){ ovPlay.focus(); }, 60); }
  function hideOverlay(){ overlay.setAttribute('aria-hidden','true'); }

  // Event wiring
  document.getElementById('r0').addEventListener('click', function(){ strike(0); });
  document.getElementById('r1').addEventListener('click', function(){ strike(1); });
  document.getElementById('r2').addEventListener('click', function(){ strike(2); });
  document.getElementById('rest').addEventListener('click', rest);
  document.getElementById('pause').addEventListener('click', function(){ if(overlay.getAttribute('aria-hidden')==='false'){ hideOverlay(); newRun(); } else { togglePause(); } });
  document.getElementById('new').addEventListener('click', function(){ newRun(); });
  document.getElementById('resetData').addEventListener('click', resetData);
  ovPlay.addEventListener('click', function(){ newRun(); });

  document.addEventListener('keydown', function(e){
    const k=e.key.toLowerCase();
    if(k==='1'){ strike(0); }
    else if(k==='2'){ strike(1); }
    else if(k==='3'){ strike(2); }
    else if(k==='r'){ rest(); }
    else if(k===' '){ e.preventDefault(); togglePause(); }
    else if(k==='n'){ newRun(); }
  });

  // Init
  buildGrid();
  zeroGrid();
  loadBest();
  updateStats();
  showOverlay();
})();
</script>
</body>
</html>